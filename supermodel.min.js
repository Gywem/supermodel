(function(a){var b=this,c=b.Supermodel={};c.VERSION="0.0.3";var d=a.Collection,e=a.Model.extend,f=function(a,b){m(b,"name"),_.extend(this,_.pick(b,"name","where")),this.source=b.source||this.name,this.store=b.store||"_"+this.name;var c=a;while(c!==k){if(c.associations()[this.name])throw new Error("Association already exists: "+this.name);c=c.__super__.constructor}a.associations()[this.name]=this,this.initialize&&a.all().on("initialize",this.initialize,this),this.change&&a.all().on("change",this.change,this),this.parse&&a.all().on("parse",this.parse,this),this.destroy&&a.all().on("destroy",this.destroy,this),this.create&&a.all().on("add",this.create,this)};f.extend=e,_.extend(f.prototype,{associate:function(a,b){if(!this.inverse)return;a.trigger("associate:"+this.inverse,a,b)},dissociate:function(a,b){if(!this.inverse)return;a.trigger("dissociate:"+this.inverse,a,b)}});var g=f.extend({constructor:function(a,b){m(b,"inverse","model"),f.apply(this,arguments),_.extend(this,_.pick(b,"inverse","model")),this.id=b.id||this.name+"_id",a.all().on("associate:"+this.name,this.replace,this).on("dissociate:"+this.name,this.remove,this)},create:function(a){a[this.name]=_.bind(this.access,this,a)},access:function(a,b){if(arguments.length<2)return a[this.store];this.replace(a,b)},initialize:function(a){this.parse(a,a.attributes);var b=a.get(this.id);b!=null&&this.replace(a,b)},parse:function(a,b){if(!_.has(b,this.source))return;var c=b[this.source];delete b[this.source],this.replace(a,c)},change:function(a){if(!a.hasChanged(this.id))return;this.replace(a,a.get(this.id))},remove:function(a){this.replace(a,null)},destroy:function(a){var b=a[this.store];if(!b)return;this.remove(a),this.dissociate(b,a)},replace:function(a,b){var c,d;if(!a)return;d=a[this.store],b!=null&&!_.isObject(b)&&(c=b,(b={})[this.model.prototype.idAttribute]=c),b&&!(b instanceof k)&&(b=this.model.create(b));if(d===b)return;b||a.unset(this.id),d&&(delete a[this.store],this.dissociate(d,a));if(!b)return;a.set(this.id,b.id),a[this.store]=b,this.associate(b,a)}}),h=f.extend({constructor:function(a,b){m(b,"inverse","collection"),f.apply(this,arguments),_.extend(this,_.pick(b,"collection","comparator","inverse")),a.all().on("associate:"+this.name,this._associate,this).on("dissociate:"+this.name,this._dissociate,this)},create:function(a){a[this.name]=_.bind(this.get,this,a);var b=a[this.store];if(b)return;b=a[this.store]=(new this.collection([],{comparator:this.comparator})).on("add",this.add,this).on("remove",this.remove,this).on("reset",this.reset,this),b[this.inverse]=b.owner=a},get:function(a){return a[this.store]},parse:function(a,b){var c=b[this.source];if(!c)return;delete b[this.source];var d=a[this.store];c=d.parse(c);if(!this.where){d.reset(c);return}d.reset(_.filter(_.map(c,function(a){return new d.model(a)}),this.where))},initialize:function(a){this.parse(a,a.attributes)},add:function(a,b){if(!a||!b)return;this.associate(a,b.owner)},remove:function(a,b){if(!a||!b)return;this.dissociate(a,b.owner)},reset:function(a){if(!a)return;a.each(function(b){this.associate(b,a.owner)},this)},destroy:function(a){var b;if(!a||!(b=a[this.store]))return;b.each(function(b){this.dissociate(b,a)},this)},_associate:function(a,b){if(!a||!b||!a[this.store])return;if(this.where&&!this.where(b))return;a[this.store].add(b)},_dissociate:function(a,b){if(!a||!b||!a[this.store])return;a[this.store].remove(b)}}),i=f.extend({constructor:function(a,b){m(b,"collection","through","source"),f.apply(this,arguments),_.extend(this,_.pick(b,"collection","through")),this._associate=l(this._associate,this),this._dissociate=l(this._dissociate,this)},create:function(a){a[this.name]||(a[this.name]=_.bind(this.get,this,a))},get:function(a){var b=a[this.store];return b||(b=new this.collection([],{comparator:this.comparator}),b.owner=a,a[this.store]=b,this.reset(a[this.through]().on("add",this.add,this).on("remove",this.remove,this).on("reset",this.reset,this).on("associate:"+this.source,this._associate).on("dissociate:"+this.source,this._dissociate))),b},add:function(a,b){if(!a||!b)return;if(!(a=a[this.source]()))return;if(this.where&&!this.where(a))return;b.owner[this.name]().add(a)},remove:function(a,b){if(!a||!b)return;if(!(a=a[this.source]()))return;var c=b.any(function(b){return b[this.source]()===a},this);c||b.owner[this.name]().remove(a)},reset:function(a){if(!a)return;var b=_.compact(_.uniq(_.invoke(a.models,this.source)));this.where&&(b=_.filter(b,this.where)),a.owner[this.name]().reset(b)},_associate:function(a,b,c){if(!a||!b||!c)return;if(this.where&&!this.where(c))return;a.owner[this.name]().add(c)},_dissociate:function(a,b,c){if(!a||!b||!c)return;var d=a.any(function(a){return a[this.source]()===c},this);d||a.owner[this.name]().remove(c)}}),j=function(a){this.model=a};_.extend(j.prototype,{one:function(a,b){return b.name=a,new g(this.model,b),this},many:function(a,b){b.name=a;var c=b.through?i:h;return new c(this.model,b),this}});var k=c.Model=a.Model.extend({cidAttribute:"cid",initialize:function(){this.set(this.cidAttribute,this.cid);var a=this.constructor;while(a!==k)a.all().add(this),a=a.__super__.constructor;this.trigger("initialize",this)},toJSON:function(){var b=a.Model.prototype.toJSON.apply(this,arguments);return delete b[this.cidAttribute],b},parse:function(a){return this.trigger("parse",this,a),a}},{create:function(a,b){var c,d=this.all(),e=a&&a[this.prototype.cidAttribute],f=a&&a[this.prototype.idAttribute];if(e&&(c=d.getByCid(e))&&c.attributes===a)return c;if(f&&(c=d.get(f)))return c.parse(a),c.set(a),c;if(!f)return new this(a,b);var g=this;while(g!==k){if(g.all().get(f))throw new Error('Model with id "'+f+'" already exists.');g=g.__super__.constructor}return new this(a,b)},has:function(){return new j(this)},all:function(){return this._all||(this._all=new d)},associations:function(){return this._associations||(this._associations={})},reset:function(){this._all=new d,this._associations={}}}),l=function(a,b){return function(){var c=[this].concat(_.toArray(arguments));return a.apply(b,c)}},m=function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];if(!a[c])throw new Error("Option required: "+c)}}}).call(this,Backbone);